import{M as ne,m as oe,u as re,ac as le,ag as ue,H as se,I as me,a7 as ie,J as ce,a3 as de,l as ye,d as V,K as pe,e as B,v as ve,a6 as _e,aF as fe,r as s,o as $,c as Pe,a as r,h as l,b as k,x as t,j as w,n as G,g as N,z as M,t as P,w as ge,F as be,p as b,q,ay as Be,ah as $e,W as he}from"./main.f0b3db12.js";import{_ as Ie}from"./ExchangeRateConverter.31e9a4fd.js";import{u as Ce}from"./payment.3a370c2f.js";import{_ as Se}from"./PaymentModeModal.77751800.js";import"./exchange-rate.d8bed942.js";const Ve={class:"absolute left-3.5"},we={class:"relative w-full"},Me="newEstimate",Ee={__name:"Create",setup(qe){const c=ne(),j=oe(),e=Ce();re();const h=le();ue(),se();const x=me(),U=ie();ce();const A=de("utils"),{t:y}=ye();let _=V(!1),I=V(!1),f=V([]);const C=V([]);pe(["customer","company","customerCustom","payment","paymentCustom"]);const S=B({get:()=>e.currentPayment.amount/100,set:n=>{e.currentPayment.amount=Math.round(n*100)}}),u=B(()=>e.isFetchingInitialData),d=B(()=>c.name==="payments.edit"),D=B(()=>d.value?y("payments.edit_payment"):y("payments.new_payment")),H=B(()=>({currentPayment:{customer_id:{required:b.withMessage(y("validation.required"),q)},payment_date:{required:b.withMessage(y("validation.required"),q)},amount:{required:b.withMessage(y("validation.required"),q),between:b.withMessage(y("validation.payment_greater_than_due_amount"),Be(0,e.currentPayment.maxPayableAmount))},exchange_rate:{required:$e(function(){return b.withMessage(y("validation.required"),q),e.showExchangeRate}),decimal:b.withMessage(y("validation.valid_exchange_rate"),he)}}})),m=ve(H,e,{$scope:Me});_e(()=>{e.currentPayment.customer_id&&T(e.currentPayment.customer_id),c.query.customer&&(e.currentPayment.customer_id=c.query.customer)}),e.resetCurrentPayment(),c.query.customer&&(e.currentPayment.customer_id=c.query.customer),e.fetchPaymentInitialData(d.value),c.params.id&&!d.value&&R();async function L(){x.openModal({title:y("settings.payment_modes.add_payment_mode"),componentName:"PaymentModeModal"})}async function R(){var a;let n=await U.fetchInvoice((a=c==null?void 0:c.params)==null?void 0:a.id);e.currentPayment.customer_id=n.data.data.customer.id,e.currentPayment.invoice_id=n.data.data.id}async function z(n){if(n){let a=0;e.currentPayment.selectedInvoices.forEach(function(i){a=a+i.due_amount}),e.currentPayment.maxPayableAmount=a}console.log(e.currentPayment.maxPayableAmount)}function T(n){if(n){let a={customer_id:n,status:"DUE",limit:"all"};d.value&&(a.status=""),I.value=!0,Promise.all([U.fetchInvoices(a),h.fetchCustomer(n)]).then(async([i,p])=>{i&&(f.value=[...i.data.data]),p&&p.data&&(e.currentPayment.selectedCustomer=p.data.data,e.currentPayment.customer=p.data.data,e.currentPayment.currency=p.data.data.currency,d.value&&!h.editCustomer&&e.currentPayment.customer_id&&(h.editCustomer=p.data.data)),e.currentPayment.invoice_id&&(C.value=f.value.find(v=>v.id===e.currentPayment.invoice_id),e.currentPayment.maxPayableAmount=C.value.due_amount+e.currentPayment.amount,S.value===0&&(S.value=C.value.due_amount/100)),d.value&&(f.value=f.value.filter(v=>v.due_amount>0||v.id==e.currentPayment.invoice_id)),I.value=!1}).catch(i=>{I.value=!1,console.error(i,"error")})}}fe(()=>{e.resetCurrentPayment(),f.value=[],h.editCustomer=null});async function J(){if(m.value.$touch(),m.value.$invalid)return!1;_.value=!0;let n={...e.currentPayment},a=null;try{a=await(d.value?e.updatePayment:e.addPayment)(n),j.push(`/admin/payments/${a.data.data.id}/view`)}catch{_.value=!1}}function K(n){let a={userId:n};c.params.id&&(a.model_id=c.params.id),e.currentPayment.invoice_id=C.value=null,e.currentPayment.amount=0,f.value=[],e.getNextNumber(a,!0)}return(n,a)=>{const i=s("BaseBreadcrumbItem"),p=s("BaseBreadcrumb"),v=s("BaseIcon"),E=s("BaseButton"),W=s("BasePageHeader"),O=s("BaseDatePicker"),g=s("BaseInputGroup"),Q=s("BaseInput"),X=s("BaseCustomerSelectInput"),F=s("BaseMultiselect"),Y=s("BaseMoney"),Z=s("BaseSelectAction"),ee=s("BaseInputGrid"),te=s("BaseCard"),ae=s("BasePage");return $(),Pe(be,null,[r(Se),r(ae,{class:"relative payment-create"},{default:l(()=>[k("form",{action:"",onSubmit:ge(J,["prevent"])},[r(W,{title:D.value,class:"mb-5"},{actions:l(()=>[r(E,{loading:t(_),disabled:t(_),variant:"primary",type:"submit",class:"hidden sm:flex"},{left:l(o=>[t(_)?N("",!0):($(),w(v,{key:0,name:"SaveIcon",class:G(o.class)},null,8,["class"]))]),default:l(()=>[M(" "+P(d.value?n.$t("payments.update_payment"):n.$t("payments.save_payment")),1)]),_:1},8,["loading","disabled"])]),default:l(()=>[r(p,null,{default:l(()=>[r(i,{title:n.$t("general.home"),to:"/admin/dashboard"},null,8,["title"]),r(i,{title:n.$tc("payments.payment",2),to:"/admin/payments"},null,8,["title"]),r(i,{title:D.value,to:"#",active:""},null,8,["title"])]),_:1})]),_:1},8,["title"]),r(te,null,{default:l(()=>[r(ee,null,{default:l(()=>[r(g,{label:n.$t("payments.date"),"content-loading":u.value,required:"",error:t(m).currentPayment.payment_date.$error&&t(m).currentPayment.payment_date.$errors[0].$message},{default:l(()=>[r(O,{modelValue:t(e).currentPayment.payment_date,"onUpdate:modelValue":[a[0]||(a[0]=o=>t(e).currentPayment.payment_date=o),a[1]||(a[1]=o=>t(m).currentPayment.payment_date.$touch())],"content-loading":u.value,"calendar-button":!0,"calendar-button-icon":"calendar",invalid:t(m).currentPayment.payment_date.$error},null,8,["modelValue","content-loading","invalid"])]),_:1},8,["label","content-loading","error"]),r(g,{label:n.$t("payments.payment_number"),"content-loading":u.value,required:""},{default:l(()=>[r(Q,{modelValue:t(e).currentPayment.payment_number,"onUpdate:modelValue":a[2]||(a[2]=o=>t(e).currentPayment.payment_number=o),"content-loading":u.value},null,8,["modelValue","content-loading"])]),_:1},8,["label","content-loading"]),r(g,{label:n.$t("payments.customer"),error:t(m).currentPayment.customer_id.$error&&t(m).currentPayment.customer_id.$errors[0].$message,"content-loading":u.value,required:""},{default:l(()=>[u.value?N("",!0):($(),w(X,{key:0,modelValue:t(e).currentPayment.customer_id,"onUpdate:modelValue":[a[3]||(a[3]=o=>t(e).currentPayment.customer_id=o),a[4]||(a[4]=o=>K(t(e).currentPayment.customer_id))],"content-loading":u.value,invalid:t(m).currentPayment.customer_id.$error,placeholder:n.$t("customers.select_a_customer"),"show-action":""},null,8,["modelValue","content-loading","invalid","placeholder"]))]),_:1},8,["label","error","content-loading"]),r(g,{"content-loading":u.value,label:n.$t("payments.invoice"),"help-text":t(e).currentPayment.selectedInvoices?`Monto a pagar: ${t(e).currentPayment.maxPayableAmount/100}`:""},{default:l(()=>[r(F,{modelValue:t(e).currentPayment.selectedInvoices,"onUpdate:modelValue":a[5]||(a[5]=o=>t(e).currentPayment.selectedInvoices=o),mode:"tags",object:!0,label:"invoice_number",options:t(f),"content-loading":u.value,"value-prop":"id","track-by":"invoice_number",loading:t(I),placeholder:n.$t("invoices.select_invoice"),"can-deselect":!0,onSelect:z},{singlelabel:l(({value:o})=>[k("div",Ve,P(o.invoice_number)+" ("+P(t(A).formatMoney(o.total,o.customer.currency))+") ",1)]),option:l(({option:o})=>[M(P(o.invoice_number)+" ("+P(t(A).formatMoney(o.total,o.customer.currency))+") ",1)]),_:1},8,["modelValue","options","content-loading","loading","placeholder"])]),_:1},8,["content-loading","label","help-text"]),r(g,{label:n.$t("payments.amount"),"content-loading":u.value,error:t(m).currentPayment.amount.$error&&t(m).currentPayment.amount.$errors[0].$message,required:""},{default:l(()=>[k("div",we,[($(),w(Y,{key:t(e).currentPayment.currency,modelValue:S.value,"onUpdate:modelValue":[a[6]||(a[6]=o=>S.value=o),a[7]||(a[7]=o=>t(m).currentPayment.amount.$touch())],currency:t(e).currentPayment.currency,"content-loading":u.value,invalid:t(m).currentPayment.amount.$error},null,8,["modelValue","currency","content-loading","invalid"]))])]),_:1},8,["label","content-loading","error"]),r(g,{"content-loading":u.value,label:n.$t("payments.payment_mode")},{default:l(()=>[r(F,{modelValue:t(e).currentPayment.payment_method_id,"onUpdate:modelValue":a[8]||(a[8]=o=>t(e).currentPayment.payment_method_id=o),"content-loading":u.value,label:"name","value-prop":"id","track-by":"name",options:t(e).paymentModes,placeholder:n.$t("payments.select_payment_mode"),searchable:""},{action:l(()=>[r(Z,{onClick:L},{default:l(()=>[r(v,{name:"PlusIcon",class:"h-4 mr-2 -ml-2 text-center text-primary-400"}),M(" "+P(n.$t("settings.payment_modes.add_payment_mode")),1)]),_:1})]),_:1},8,["modelValue","content-loading","options","placeholder"])]),_:1},8,["content-loading","label"]),r(Ie,{store:t(e),"store-prop":"currentPayment",v:t(m).currentPayment,"is-loading":u.value,"is-edit":d.value,"customer-currency":t(e).currentPayment.currency_id},null,8,["store","v","is-loading","is-edit","customer-currency"])]),_:1}),r(E,{loading:t(_),"content-loading":u.value,variant:"primary",type:"submit",class:"flex justify-center w-full mt-4 sm:hidden md:hidden"},{left:l(o=>[t(_)?N("",!0):($(),w(v,{key:0,name:"SaveIcon",class:G(o.class)},null,8,["class"]))]),default:l(()=>[M(" "+P(d.value?n.$t("payments.update_payment"):n.$t("payments.save_payment")),1)]),_:1},8,["loading","content-loading"])]),_:1})],32)]),_:1})],64)}}};export{Ee as default};
